// Generated by LiveScript 1.3.0
(function(){
  ldc.register('admin', ['loader', 'notify'], function(arg$){
    var loader, notify, lc, view, fetch;
    loader = arg$.loader, notify = arg$.notify;
    lc = {
      list: []
    };
    view = new ldView({
      initRender: false,
      root: '[ld-scope=admin]',
      action: {
        click: {
          accept: function(arg$){
            var node;
            node = arg$.node;
            return fetch('accept');
          },
          reject: function(arg$){
            var node;
            node = arg$.node;
            return fetch('reject');
          },
          pending: function(arg$){
            var node;
            node = arg$.node;
            return fetch('pending');
          }
        }
      },
      handler: {
        item: {
          list: function(){
            return lc.list;
          },
          action: {
            click: function(arg$){
              var node, data, evt, n, act;
              node = arg$.node, data = arg$.data, evt = arg$.evt;
              n = evt.target;
              if (!n || !n.classList) {
                return;
              }
              if (!n.classList.contains('btn')) {
                return;
              }
              loader.on();
              act = n.getAttribute('ld');
              return ld$.fetch("/d/condolence/" + data.key + "/verify", {
                method: 'POST'
              }, {
                type: 'json',
                json: {
                  verified: act === 'ok'
                }
              })['finally'](function(){
                return loader.off();
              }).then(function(){
                notify.send('success', 'saved.');
                node.parentNode.removeChild(node);
                return lc.list.splice(lc.list.indexOf(data), 1);
              })['catch'](function(){
                return notify.send('error', "failed to save");
              });
            }
          },
          handler: function(arg$){
            var node, data;
            node = arg$.node, data = arg$.data;
            ld$.find(node, '[ld=source]', 0).innerText = data.source || '';
            ld$.find(node, '[ld=social]', 0).innerText = data.social || '';
            ld$.find(node, '[ld=content]', 0).innerText = data.content || '';
            ld$.find(node, '[ld=contact]', 0).innerText = data.contact || '';
            ld$.find(node, '[ld=publish]', 0).innerText = data.publish || '';
            if (data.image) {
              return ld$.find(node, '[ld=image]', 0).setAttribute('src', "/assets/uploads/" + data.key + ".png");
            }
          }
        }
      }
    });
    fetch = function(v){
      var offset;
      offset = +(ld$.find("[ld=offset]", 0).value || 0);
      return ld$.fetch('/d/condolence/admin', {
        method: 'GET'
      }, {
        type: 'json',
        params: {
          offset: offset,
          verified: v
        }
      }).then(function(it){
        lc.list = it;
        return view.render();
      });
    };
    return fetch('pending');
  });
  return ldc.app('admin');
})();